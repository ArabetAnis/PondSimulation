<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Fish Pond Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better visual feedback */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .status-ok { color: #22c55e; font-weight: 600; }
        .status-warning { color: #f59e0b; font-weight: 600; }
        .status-critical { color: #ef4444; font-weight: 600; }
        .status-offline { color: #64748b; font-weight: 600; }
        .battery-bar-outer {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            height: 1rem;
            width: 100%;
        }
        .battery-bar-inner {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100 text-slate-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Fish Pond Monitoring Dashboard</h1>
            <p class="text-slate-600 mt-1">Real-time sensor simulation with interactive events.</p>
        </header>

        <!-- Controls and Status -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="md:col-span-2 bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-3">Trigger Events</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="feed-btn" class="btn w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">
                        Feed Fish
                    </button>
                    <button id="rain-btn" class="btn w-full sm:w-auto bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-600">
                        Simulate Rainfall
                    </button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-2">Last Event</h2>
                <p id="status-message" class="text-slate-700 h-full flex items-center">Simulation started. System is nominal.</p>
            </div>
        </div>

        <!-- Sensor Data Table -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="p-4 text-sm font-semibold text-slate-600">Parameter</th>
                        <th class="p-4 text-sm font-semibold text-slate-600">Value</th>
                        <th class="p-4 text-sm font-semibold text-slate-600">Status</th>
                        <th class="p-4 text-sm font-semibold text-slate-600 w-1/4">Battery</th>
                        <th class="p-4 text-sm font-semibold text-slate-600">Unit</th>
                        <th class="p-4 text-sm font-semibold text-slate-600">Actions</th>
                    </tr>
                </thead>
                <tbody id="sensor-table-body">
                    <!-- Sensor rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SIMULATION_INTERVAL_MS = 1000; // Update every 3 seconds

        const sensors = {
            "pH": {
                value: 7.8, fluctuation: 0.05, minVal: 6.0, maxVal: 9.5, unit: "",
                battery: 100.0, drainRate: 0.1,
                safeRange: [7.0, 8.5], criticalRange: [6.5, 9.0]
            },
            "Salinity": {
                value: 0.5, fluctuation: 0.02, minVal: 0, maxVal: 10, unit: "ppt",
                battery: 100.0, drainRate: 0.08,
                safeRange: [0, 2.0], criticalRange: [0, 4.0]
            },
            "Suspended Solids": {
                value: 25, fluctuation: 2, minVal: 0, maxVal: 200, unit: "mg/L",
                battery: 100.0, drainRate: 0.12,
                safeRange: [0, 50], criticalRange: [0, 80]
            },
            "Nitrite (NO2)": {
                value: 0.1, fluctuation: 0.01, minVal: 0, maxVal: 5, unit: "mg/L",
                battery: 100.0, drainRate: 0.15,
                safeRange: [0, 0.5], criticalRange: [0, 1.0]
            },
            "Nitrate (NO3)": {
                value: 20, fluctuation: 1, minVal: 0, maxVal: 100, unit: "mg/L",
                battery: 100.0, drainRate: 0.15,
                safeRange: [0, 40], criticalRange: [0, 80]
            },
            "Ammonia (NH3)": {
                value: 0.05, fluctuation: 0.01, minVal: 0, maxVal: 0.1, unit: "mg/L",
                battery: 100.0, drainRate: 0.15,
                safeRange: [0, 0.1], criticalRange: [0, 0.25]
            },
            "Water Level": {
                value: 4.5, fluctuation: 0.01, minVal: 1.0, maxVal: 5.0, unit: "m",
                battery: 100.0, drainRate: 0.05,
                safeRange: [3.0, 4.8], criticalRange: [2.0, 4.9]
            }
        };

        // --- DOM Elements ---
        const feedBtn = document.getElementById('feed-btn');
        const rainBtn = document.getElementById('rain-btn');
        const statusMessageEl = document.getElementById('status-message');
        const tableBody = document.getElementById('sensor-table-body');

        // --- Event Simulation Functions ---
        function simulateFeeding() {
            const ammoniaIncrease = Math.random() * 0.15 + 0.1;
            const solidsIncrease = Math.random() * 20 + 20;
            sensors["Ammonia (NH3)"].value += ammoniaIncrease;
            sensors["Suspended Solids"].value += solidsIncrease;
            updateStatusMessage(`Fish fed. Ammonia & Solids spiked.`);
            renderDashboard();
        }

        function simulateRainfall() {
            const rainMm = Math.random() * 30 + 20;
            const waterIncreaseM = rainMm / 1000.0;
            
            const currentLevel = sensors["Water Level"].value;
            const newLevel = currentLevel + waterIncreaseM;
            sensors["Water Level"].value = newLevel;

            const dilutionFactor = currentLevel / newLevel;
            sensors["Salinity"].value *= dilutionFactor;
            sensors["Nitrite (NO2)"].value *= dilutionFactor;
            sensors["Nitrate (NO3)"].value *= dilutionFactor;
            sensors["Ammonia (NH3)"].value *= dilutionFactor;
            
            updateStatusMessage(`Heavy rain (${rainMm.toFixed(1)}mm). Water diluted.`);
            renderDashboard();
        }

        function changeBattery(sensorName) {
            if (sensors[sensorName]) {
                sensors[sensorName].battery = 100.0;
                updateStatusMessage(`Battery replaced for ${sensorName}.`);
                renderDashboard();
            }
        }

        function updateStatusMessage(message) {
            statusMessageEl.textContent = message;
        }

        // --- Core Simulation Logic ---
        function updateSensor(sensor) {
            if (sensor.battery <= 0) return;
            const change = (Math.random() - 0.5) * 2 * sensor.fluctuation;
            sensor.value += change;
            sensor.value = Math.max(sensor.minVal, Math.min(sensor.maxVal, sensor.value));
            const drain = sensor.drainRate + (Math.random() - 0.5) * 0.01;
            sensor.battery = Math.max(0, sensor.battery - drain);
        }

        function getStatus(sensor) {
            if (sensor.battery <= 0) return { text: 'OFFLINE', class: 'status-offline' };
            const [critMin, critMax] = sensor.criticalRange;
            if (sensor.value < critMin || sensor.value > critMax) return { text: 'CRITICAL', class: 'status-critical' };
            const [safeMin, safeMax] = sensor.safeRange;
            if (sensor.value < safeMin || sensor.value > safeMax) return { text: 'WARNING', class: 'status-warning' };
            return { text: 'OK', class: 'status-ok' };
        }

        function getBatteryColor(percentage) {
            if (percentage < 20) return 'bg-red-500';
            if (percentage < 50) return 'bg-yellow-500';
            return 'bg-green-500';
        }

        // --- Rendering Function ---
        function renderDashboard() {
            tableBody.innerHTML = ''; // Clear existing table rows

            for (const name in sensors) {
                const sensor = sensors[name];
                const status = getStatus(sensor);
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-200 hover:bg-slate-50';

                let valueText = '---';
                if (sensor.battery > 0) {
                    const decimalPlaces = (sensor.unit === 'mg/L' && sensor.fluctuation < 0.1) ? 4 : 2;
                    valueText = sensor.value.toFixed(decimalPlaces);
                }
                const batteryColor = getBatteryColor(sensor.battery);
                const isBatteryFull = sensor.battery >= 99.9;

                row.innerHTML = `
                    <td class="p-4 font-medium text-slate-800">${name}</td>
                    <td class="p-4">${valueText}</td>
                    <td class="p-4"><span class="${status.class}">${status.text}</span></td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <div class="w-full battery-bar-outer">
                                <div class="battery-bar-inner ${batteryColor}" style="width: ${sensor.battery}%;"></div>
                            </div>
                            <span class="text-sm font-semibold w-12 text-right">${sensor.battery.toFixed(1)}%</span>
                        </div>
                    </td>
                    <td class="p-4 text-slate-500">${sensor.unit}</td>
                    <td class="p-4 text-center">
                        <button 
                            class="btn change-battery-btn bg-emerald-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-emerald-600" 
                            data-sensor-name="${name}" 
                            ${isBatteryFull ? 'disabled' : ''}>
                            Replace
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        // --- Initialization ---
        function init() {
            feedBtn.addEventListener('click', simulateFeeding);
            rainBtn.addEventListener('click', simulateRainfall);

            // Event delegation for battery change buttons
            tableBody.addEventListener('click', (event) => {
                if (event.target.classList.contains('change-battery-btn')) {
                    const sensorName = event.target.dataset.sensorName;
                    changeBattery(sensorName);
                }
            });

            renderDashboard();

            let simulationInterval = setInterval(() => {
                let activeSensors = 0;
                for (const name in sensors) {
                    updateSensor(sensors[name]);
                    if (sensors[name].battery > 0) activeSensors++;
                }
                renderDashboard();

                if (activeSensors === 0) {
                    updateStatusMessage('All sensors are offline. Simulation ended.');
                    clearInterval(simulationInterval); // Stop the loop
                }
            }, SIMULATION_INTERVAL_MS);
        }

        window.onload = init;
    </script>
</body>
</html>
