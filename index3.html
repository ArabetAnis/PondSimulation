<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fish Pond Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .status-ok { color: #22c55e; font-weight: 600; }
        .status-warning { color: #f59e0b; font-weight: 600; }
        .status-critical { color: #ef4444; font-weight: 600; }
        .status-offline { color: #64748b; font-weight: 600; }
        .battery-bar-outer {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            height: 0.75rem;
            width: 100%;
        }
        .battery-bar-inner {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
        .chart-container {
            position: relative;
            height: 60px;
            width: 100%;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100 text-slate-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Advanced Fish Pond Dashboard</h1>
            <p class="text-slate-600 mt-1">Live data charts, interactive events, and Dissolved Oxygen simulation.</p>
        </header>

        <!-- Controls and Status -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="md:col-span-2 bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-3">System Controls</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="feed-btn" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Feed Fish</button>
                    <button id="rain-btn" class="btn bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-600">Simulate Rainfall</button>
                    <button id="aerator-btn" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">Turn On Aerator</button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-2">Last Event</h2>
                <p id="status-message" class="text-slate-700 h-full flex items-center">Simulation started. System is nominal.</p>
            </div>
        </div>

        <!-- Sensor Data Table -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="p-4 text-sm font-semibold text-slate-600">Parameter</th>
                        <th class="p-4 text-sm font-semibold text-slate-600">Value</th>
                        <th class="p-4 text-sm font-semibold text-slate-600">Status</th>
                        <th class="p-4 text-sm font-semibold text-slate-600 w-1/6">Trend (1 min)</th>
                        <th class="p-4 text-sm font-semibold text-slate-600 w-1/6">Battery</th>
                        <th class="p-4 text-sm font-semibold text-slate-600">Actions</th>
                    </tr>
                </thead>
                <tbody id="sensor-table-body">
                    <!-- Sensor rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SIMULATION_INTERVAL_MS = 2000; // Update every 2 seconds
        const MAX_HISTORY_POINTS = 30; // 30 points * 2s = 1 minute of history

        const sensors = {
            "Dissolved Oxygen": {
                value: 8.0, fluctuation: 0.05, minVal: 0, maxVal: 15, unit: "mg/L",
                battery: 100.0, drainRate: 0.09,
                safeRange: [6.0, 12.0], criticalRange: [4.0, 14.0],
                history: [], chart: null
            },
            "pH": {
                value: 7.8, fluctuation: 0.05, minVal: 6.0, maxVal: 9.5, unit: "",
                battery: 100.0, drainRate: 0.1,
                safeRange: [7.0, 8.5], criticalRange: [6.5, 9.0],
                history: [], chart: null
            },
            "Ammonia (NH3)": {
                value: 0.05, fluctuation: 0.01, minVal: 0, maxVal: 2, unit: "mg/L",
                battery: 100.0, drainRate: 0.15,
                safeRange: [0, 0.1], criticalRange: [0, 0.25],
                history: [], chart: null
            },
            "Nitrite (NO2)": {
                value: 0.1, fluctuation: 0.01, minVal: 0, maxVal: 5, unit: "mg/L",
                battery: 100.0, drainRate: 0.15,
                safeRange: [0, 0.5], criticalRange: [0, 1.0],
                history: [], chart: null
            },
            "Nitrate (NO3)": {
                value: 20, fluctuation: 1, minVal: 0, maxVal: 100, unit: "mg/L",
                battery: 100.0, drainRate: 0.15,
                safeRange: [0, 40], criticalRange: [0, 80],
                history: [], chart: null
            },
            "Suspended Solids": {
                value: 25, fluctuation: 2, minVal: 0, maxVal: 200, unit: "mg/L",
                battery: 100.0, drainRate: 0.12,
                safeRange: [0, 50], criticalRange: [0, 80],
                history: [], chart: null
            },
            "Salinity": {
                value: 0.5, fluctuation: 0.02, minVal: 0, maxVal: 10, unit: "ppt",
                battery: 100.0, drainRate: 0.08,
                safeRange: [0, 2.0], criticalRange: [0, 4.0],
                history: [], chart: null
            },
            "Water Level": {
                value: 4.5, fluctuation: 0.01, minVal: 1.0, maxVal: 5.0, unit: "m",
                battery: 100.0, drainRate: 0.05,
                safeRange: [3.0, 4.8], criticalRange: [2.0, 4.9],
                history: [], chart: null
            }
        };

        const dom = {
            feedBtn: document.getElementById('feed-btn'),
            rainBtn: document.getElementById('rain-btn'),
            aeratorBtn: document.getElementById('aerator-btn'),
            statusMessageEl: document.getElementById('status-message'),
            tableBody: document.getElementById('sensor-table-body')
        };

        // --- Event Functions ---
        function simulateFeeding() {
            sensors["Ammonia (NH3)"].value += Math.random() * 0.15 + 0.1;
            sensors["Suspended Solids"].value += Math.random() * 20 + 20;
            updateStatusMessage(`Fish fed. Ammonia & Solids spiked.`);
        }

        function simulateRainfall() {
            const rainMm = Math.random() * 30 + 20;
            const waterIncreaseM = rainMm / 1000.0;
            const currentLevel = sensors["Water Level"].value;
            const newLevel = currentLevel + waterIncreaseM;
            sensors["Water Level"].value = newLevel;
            const dilutionFactor = currentLevel / newLevel;
            ["Salinity", "Nitrite (NO2)", "Nitrate (NO3)", "Ammonia (NH3)"].forEach(name => {
                sensors[name].value *= dilutionFactor;
            });
            updateStatusMessage(`Heavy rain (${rainMm.toFixed(1)}mm). Water diluted.`);
        }

        function runAerator() {
            sensors["Dissolved Oxygen"].value += Math.random() * 2 + 1;
            updateStatusMessage(`Aerator running. Dissolved Oxygen increased.`);
        }

        function changeBattery(sensorName) {
            if (sensors[sensorName]) {
                sensors[sensorName].battery = 100.0;
                updateStatusMessage(`Battery replaced for ${sensorName}.`);
            }
        }

        function updateStatusMessage(message) {
            dom.statusMessageEl.textContent = message;
        }

        // --- Core Simulation Logic ---
        function updateSensor(name, sensor) {
            if (sensor.battery <= 0) return;

            // Special logic for Dissolved Oxygen
            if (name === "Dissolved Oxygen") {
                let depletion = 0.1; // Base depletion
                if (sensors["Ammonia (NH3)"].value > 0.15) {
                    depletion += 0.15; // Extra depletion if ammonia is high
                }
                sensor.value -= depletion;
            }

            // Natural fluctuation
            const change = (Math.random() - 0.5) * 2 * sensor.fluctuation;
            sensor.value += change;
            sensor.value = Math.max(sensor.minVal, Math.min(sensor.maxVal, sensor.value));

            // Drain battery
            const drain = sensor.drainRate + (Math.random() - 0.5) * 0.01;
            sensor.battery = Math.max(0, sensor.battery - drain);

            // Update history for chart
            sensor.history.push(sensor.value);
            if (sensor.history.length > MAX_HISTORY_POINTS) {
                sensor.history.shift();
            }
        }

        function getStatus(sensor) {
            if (sensor.battery <= 0) return { text: 'OFFLINE', class: 'status-offline' };
            const [critMin, critMax] = sensor.criticalRange;
            if (sensor.value < critMin || sensor.value > critMax) return { text: 'CRITICAL', class: 'status-critical' };
            const [safeMin, safeMax] = sensor.safeRange;
            if (sensor.value < safeMin || sensor.value > safeMax) return { text: 'WARNING', class: 'status-warning' };
            return { text: 'OK', class: 'status-ok' };
        }

        // --- Rendering & Charting ---
        function createInitialTable() {
            for (const name in sensors) {
                const sensor = sensors[name];
                const row = document.createElement('tr');
                row.id = `row-${name.replace(/\s|\(|\)/g, '')}`;
                row.className = 'border-b border-slate-200';
                row.innerHTML = `
                    <td class="p-4 font-medium text-slate-800">${name} <span class="block text-xs text-slate-500 font-normal">${sensor.unit}</span></td>
                    <td class="p-4 text-xl font-semibold text-slate-900" data-role="value"></td>
                    <td class="p-4" data-role="status"></td>
                    <td class="p-4">
                        <div class="chart-container">
                            <canvas id="chart-${name.replace(/\s|\(|\)/g, '')}"></canvas>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <div class="w-full battery-bar-outer">
                                <div class="battery-bar-inner" data-role="battery-bar"></div>
                            </div>
                            <span class="text-sm font-semibold w-12 text-right" data-role="battery-text"></span>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <button class="btn change-battery-btn bg-emerald-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-emerald-600" data-sensor-name="${name}">Replace</button>
                    </td>
                `;
                dom.tableBody.appendChild(row);
            }
        }

        function createCharts() {
            for (const name in sensors) {
                const sensor = sensors[name];
                const ctx = document.getElementById(`chart-${name.replace(/\s|\(|\)/g, '')}`).getContext('2d');
                sensor.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(MAX_HISTORY_POINTS).fill(''),
                        datasets: [{
                            data: sensor.history,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { x: { display: false }, y: { display: false } },
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            }
        }
        
        function updateDashboard() {
            for (const name in sensors) {
                const sensor = sensors[name];
                const row = document.getElementById(`row-${name.replace(/\s|\(|\)/g, '')}`);
                const status = getStatus(sensor);
                
                let valueText = '---';
                if (sensor.battery > 0) {
                    const decimalPlaces = (name.includes("Ammonia") || name.includes("Nitrite")) ? 4 : 2;
                    valueText = sensor.value.toFixed(decimalPlaces);
                }
                
                row.querySelector('[data-role="value"]').textContent = valueText;
                row.querySelector('[data-role="status"]').innerHTML = `<span class="${status.class}">${status.text}</span>`;
                
                const batteryBar = row.querySelector('[data-role="battery-bar"]');
                const batteryText = row.querySelector('[data-role="battery-text"]');
                const batteryBtn = row.querySelector('.change-battery-btn');

                batteryBar.style.width = `${sensor.battery}%`;
                batteryBar.className = `battery-bar-inner ${sensor.battery < 20 ? 'bg-red-500' : sensor.battery < 50 ? 'bg-yellow-500' : 'bg-green-500'}`;
                batteryText.textContent = `${sensor.battery.toFixed(1)}%`;
                batteryBtn.disabled = sensor.battery >= 99.9;

                // Update chart data
                if (sensor.chart) {
                    sensor.chart.data.datasets[0].data = sensor.history;
                    sensor.chart.update('none'); // 'none' for no animation
                }
            }
        }

        // --- Initialization ---
        function init() {
            createInitialTable();
            createCharts();

            dom.feedBtn.addEventListener('click', simulateFeeding);
            dom.rainBtn.addEventListener('click', simulateRainfall);
            dom.aeratorBtn.addEventListener('click', runAerator);

            dom.tableBody.addEventListener('click', (event) => {
                if (event.target.classList.contains('change-battery-btn')) {
                    changeBattery(event.target.dataset.sensorName);
                }
            });

            let simulationInterval = setInterval(() => {
                let activeSensors = 0;
                for (const name in sensors) {
                    updateSensor(name, sensors[name]);
                    if (sensors[name].battery > 0) activeSensors++;
                }
                updateDashboard();

                if (activeSensors === 0) {
                    updateStatusMessage('All sensors are offline. Simulation ended.');
                    clearInterval(simulationInterval);
                }
            }, SIMULATION_INTERVAL_MS);
        }

        window.onload = init;
    </script>
</body>
</html>
